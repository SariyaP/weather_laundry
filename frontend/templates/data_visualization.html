{% extends 'base.html' %}
{% load static %}

{% block content %}
    <nav class="navbar navbar-expand-lg transparent-background fixed-top px-3">
  <div class="container-fluid">
    <a class="navbar-brand text-white display-4">Weather & Laundry</a>
    <div class="ms-auto">
      <button class="btn btn-outline-0 text-white" onclick="window.location.href='/'">
        <i class="bi bi-house"></i>
      </button>
    </div>
  </div>
</nav>
<div class="container mt-3 pt-3 my-4">
  <h2 class="text-white text-center mb-4">Last 24 Hours Weather Trends</h2>
  
  <div class="d-flex justify-content-center mb-3">
    <select id="metricSelector" class="form-select transparent-background text-white" style="max-width: 250px;">
      <option class="text-black" value="temp">Temperature (°C)</option>
      <option class="text-black" value="humidity">Humidity (%)</option>
      <option class="text-black" value="wind">Wind Speed (kph)</option>
    </select>
  </div>
<div class="row px-3">
  <!-- Left Column: Chart -->
  <div class="col-md-8 mb-4">
    <div class="card transparent-background round border-0 h-100">
      <div class="card-body">
        <canvas id="weatherChart" height="100"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-4">
    <div class="card transparent-background round border-0 h-100">
      <div class="card-body text-white">
        <h5 class="card-title mb-3">Statistics</h5>
        <ul class="list-unstyled small">
          <li><strong>Max:</strong> <span id="eda-max">{{ avg }}</span></li>
          <li><strong>Min:</strong> <span id="eda-min">--</span></li>
          <li><strong>Mean:</strong> <span id="eda-mean">--</span></li>
          <li><strong>Std Dev:</strong> <span id="eda-std">--</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartInstance;

  function fetchAndRender(metric) {
    fetch('http://127.0.0.1:8080/laundry-api/v1/api/hourly-avg')
      .then(response => response.json())
      .then(data => {
        const labels = data.map(entry => entry.hour).reverse();
        let values;

        if (metric === "temp") {
          values = data.map(entry => entry.avg_temp).reverse();
        } else if (metric === "humidity") {
          values = data.map(entry => entry.avg_humidity).reverse();
        } else if (metric === "wind") {
          values = data.map(entry => entry.avg_wind).reverse();
        }

        const datasets = {
          temp: { label: "Temperature (°C)", borderColor: "#ffcc00" },
          humidity: { label: "Humidity (%)", borderColor: "#00ccff" },
          wind: { label: "Wind Speed (kph)", borderColor: "#66ff66" }
        };

        const ctx = document.getElementById('weatherChart').getContext('2d');

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: datasets[metric].label,
              data: values,
              borderColor: datasets[metric].borderColor,
              fill: false,
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: "white" }
              }
            },
            scales: {
              x: {
                ticks: { color: "white" },
                  title: {
                display: true,
                text: 'Hour of Day',
                color: 'white'
              }
              },
              y: {
                ticks: { color: "white" },
                  title: {
                display: true,
                text: datasets[metric].label,
                color: 'white'
              }
              }
            }
          }
        });
      })
      .catch(err => console.error("Failed to fetch data:", err));
  }

  document.addEventListener('DOMContentLoaded', function () {
    const selector = document.getElementById('metricSelector');
    fetchAndRender(selector.value);

    selector.addEventListener('change', () => {
      fetchAndRender(selector.value);
    });
  });

  document.addEventListener('DOMContentLoaded', function () {
  fetch('http://127.0.0.1:8080/laundry-api/v1/api/hourly-avg')
    .then(response => response.json())
    .then(data => {
      const values = data.map(entry => entry.avg_temp);

      const max = Math.max(...values);
      const min = Math.min(...values);
      const mean = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
      const std = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / values.length).toFixed(1);

      document.getElementById('eda-max').textContent = max;
      document.getElementById('eda-min').textContent = min;
      document.getElementById('eda-mean').textContent = mean;
      document.getElementById('eda-std').textContent = std;
    })
    .catch(error => console.error('Error fetching EDA data:', error));
});

</script>
{% endblock %}
